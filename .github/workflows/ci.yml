name: CI

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]
    workflow_dispatch:
    schedule:
        - cron: "0 6 * * 0,3" # Every Sunday and Wednesday at 07:00 UTC+1 Paris

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    fmt:
        name: Format check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - run: cargo fmt --all -- --check

    lint:
        name: Lint check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - uses: Swatinem/rust-cache@v2
            - run: cargo clippy --all-targets --all-features # not yet at the point i can use this flag : -- -D warnings

    build:
        name: Build (debug)
        runs-on: ubuntu-latest
        needs: [fmt, lint]
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
            - run: cargo build --all-features

    unit_test_core:
        name: Unit Tests (troc-core)
        needs: [build]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
            - uses: taiki-e/install-action@v2
              with:
                  tool: cargo-nextest
            - run: cargo nextest run -p troc-core

    coverage:
        name: Code Coverage (troc-core)
        needs: [unit_test_core]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
            - uses: taiki-e/install-action@v2
              with:
                  tool: cargo-tarpaulin
            - run: cargo tarpaulin --out html --out xml
            - name: Create badge
              run: |
                  COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1 | awk '{printf "%.2f", $1 * 100}')
                  echo "Coverage: $COVERAGE%"
                  cat > coverage/coverage-badge.json << EOF
                  {
                  "schemaVersion": 1,
                  "label": "coverage",
                  "message": "${COVERAGE}%",
                  "color": "$(if (( $(echo "${COVERAGE} >= 80" | bc -l) )); then echo "brightgreen"; else echo "orange"; fi)"
                  }
                  EOF
            - name: Upload coverage pages artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/

    mutants:
        name: Mutation tests (troc-core)
        needs: [unit_test_core]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: taiki-e/install-action@v2
              with:
                  tool: cargo-mutants
            - run: cargo mutants -p troc-core --exclude-re troc-core/benches --exclude-re troc-core/src/common --exclude-re troc-core/src/messages --exclude-re troc-core/src/types --exclude-re troc-core/src/publication --exclude-re troc-core/src/subscription -j2 -vV
              continue-on-error: true
            - name: Generate badge
              run: |
                  CAUGHT=$(wc -l < mutants.out/caught.txt)
                  MISSED=$(wc -l < mutants.out/missed.txt)
                  TOTAL=$((CAUGHT + MISSED))
                  PERCENT=$((CAUGHT * 100 / TOTAL))
                  echo "{\"schemaVersion\":1,\"label\":\"mutants\",\"message\":\"${CAUGHT}/${TOTAL} (${PERCENT}%)\",\"color\":\"$([ $PERCENT -gt 80 ] && echo 'green' || echo 'orange')\"}" > mutants.out/badge.json
            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: mutants-out
                  path: mutants.out

    deploy:
        needs: [coverage, mutants]
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - uses: actions/checkout@v4
            - name: Fetch coverage report
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path: coverage/
            - name: Fetch mutation assets
              uses: actions/download-artifact@v4
              with:
                  name: mutants-out
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path: mutants.out/
            - name: Prepare pages directory
              run: |
                  mkdir -p pages/coverage pages/mutation
                  cp -r coverage/tarpaulin-report.html pages/coverage/
                  cp -r coverage/coverage-badge.json pages/coverage/
                  cp mutants.out/badge.json pages/mutation/badge.json
                  cp .github/pages/index.html pages/
            - name: Configure pages
              uses: actions/configure-pages@v5
            - name: Upload pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: pages/
            - id: deployment
              uses: actions/deploy-pages@v4
