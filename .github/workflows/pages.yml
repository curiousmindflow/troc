name: Pages

on:
    workflow_run:
        workflows: ["CI"]
        branches: [master]
        types:
            - completed

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - uses: actions/checkout@v4
            - uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path: coverage/
            - uses: actions/configure-pages@v5
            - run: |
                  mkdir -p _pages/coverage
                  cp -r coverage/* _pages/coverage/
                  cp .github/pages/index.html _pages/
            - run: |
                  COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1 | awk '{printf "%.2f", $1 * 100}')
                  echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
                  echo "Coverage: $COVERAGE%"
            - run: |
                  mkdir -p _pages
                  cat > _pages/coverage-badge.json << EOF
                  {
                  "schemaVersion": 1,
                  "label": "coverage",
                  "message": "${COVERAGE}%",
                  "color": "$(if (( $(echo "${COVERAGE} >= 80" | bc -l) )); then echo "brightgreen"; else echo "orange"; fi)"
                  }
                  EOF
            - uses: actions/upload-pages-artifact@v3
              with:
                  path: _pages/
            - id: deployment
              uses: actions/deploy-pages@v4
