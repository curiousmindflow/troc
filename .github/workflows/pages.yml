name: Pages

on:
    workflow_run:
        workflows: ["Code coverage", "Mutation testing"]
        branches: [master, develop]
        types: [completed]

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - uses: actions/checkout@v4
            - name: Fetch coverage report
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path: coverage/
            - name: Fetch mutation assets
              uses: actions/download-artifact@v4
              with:
                  name: mutants-out
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path: mutants.out/
            - name: Create pages directory
              run: mkdir -p pages
            - name: Copy coverage report in pages directory
              run: |
                  mkdir -p pages/coverage
                  cp -r coverage/* pages/coverage/
                  cp .github/pages/index.html pages/
            - name: Create coverage badge
              run: |
                  COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1 | awk '{printf "%.2f", $1 * 100}')
                  echo "Coverage: $COVERAGE%"
                  cat > pages/coverage-badge.json << EOF
                  {
                  "schemaVersion": 1,
                  "label": "coverage",
                  "message": "${COVERAGE}%",
                  "color": "$(if (( $(echo "${COVERAGE} >= 80" | bc -l) )); then echo "brightgreen"; else echo "orange"; fi)"
                  }
                  EOF
            - name: Generate mutation badge
              run: |
                  CAUGHT=$(wc -l < mutants.out/caught.txt)
                  MISSED=$(wc -l < mutants.out/missed.txt)
                  TOTAL=$((CAUGHT + MISSED))
                  PERCENT=$((CAUGHT * 100 / TOTAL))
                  echo "{\"schemaVersion\":1,\"label\":\"mutants\",\"message\":\"${CAUGHT}/${TOTAL} (${PERCENT}%)\",\"color\":\"$([ $PERCENT -gt 80 ] && echo 'green' || echo 'orange')\"}" > mutants.out/badge.json
            - name: Configure pages
              uses: actions/configure-pages@v5
            - name: Upload pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: pages/
            - id: deployment
              uses: actions/deploy-pages@v4
              if: github.event.workflow_run.head_branch == 'master'
