name: Mutation testing

on:
    workflow_run:
        workflows: [CI]
        types: [completed]
        branches: [master, develop]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    mutation_testing:
        name: Mutation tests (troc-core)
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: taiki-e/install-action@v2
              with:
                  tool: cargo-mutants
            - run: cargo mutants -p troc-core --exclude-re troc-core/benches --exclude-re troc-core/src/common --exclude-re troc-core/src/messages --exclude-re troc-core/src/types --exclude-re troc-core/src/publication --exclude-re troc-core/src/subscription -j2 -vV
              continue-on-error: true
            - name: Generate badge
              run: |
                  CAUGHT=$(wc -l < mutants.out/caught.txt)
                  MISSED=$(wc -l < mutants.out/missed.txt)
                  TOTAL=$((CAUGHT + MISSED))
                  PERCENT=$((CAUGHT * 100 / TOTAL))
                  echo "{\"schemaVersion\":1,\"label\":\"mutants\",\"message\":\"${CAUGHT}/${TOTAL} (${PERCENT}%)\",\"color\":\"$([ $PERCENT -gt 80 ] && echo 'green' || echo 'orange')\"}" > mutants.out/badge.json
            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: mutants-out
                  path: mutants.out
